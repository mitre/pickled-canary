; This pattern tests for the patch of CVE-2015-3144 for MIPS:BE:32:default.

; Info about the CVE: https://github.com/curl/curl/commit/0583e87ada7a3cfb10904ae4ab61b339582c5bd3
; Summary: A hostname is passed into a function, and the last character (len - 1) character is
; read. It is also set to a null character if certain conditions are met. A hostname that has a
; length of zero will cause the program to read and write to memory not part of the hostname.

; Patched code:
; len = strlen(host->name);
; if(len && (host->name[len-1] == '.')) //makes sure len is not negative
;   host->name[len-1]=0;

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.5.4.0_3.9.3.7537.bin.de3ea486b7cbea778d09bd93ee1ab7fc213302a3861cadc575aa0704ffc94705
;        00028008 03  20  f8  09    jalr       t9=><EXTERNAL>::strlen
;        0002800c 00  a0  88  21    _move      s1,a1
;        00028010 10  40  00  07    beq        v0,zero ,LAB_00028030
;        00028014 8f  bc  00  10    _lw        gp,local_18 (sp)
;        00028018 02  02  20  21    addu       a0,s0,v0
;        0002801c 80  83  ff  ff    lb         v1,-0x1 (a0)
;        00028020 24  02  00  2e    li         v0,0x2e
;        00028024 14  62  00  02    bne        v1,v0,LAB_00028030
;        00028028 00  00  00  00    _nop
;        0002802c a0  80  ff  ff    sb         zero ,-0x1 (a0)

; call to strlen
jalr `*`

`ANY_BYTES{0,4}`

; check whether len is 0 and short circuit if it is 0
beq `*`,zero,`Q1/.*`

`ANY_BYTES{0,8}`

; load the last character of the hostname (host->name[len-1]) into Q2
lb `Q2/v.`,-0x1(`Q3/a.`)

; load '.' into Q4
li `Q4/v.`,0x2e

; check whether the last character of the hostname is '.', and jump if it is not '.'
bne `Q2`,`Q4`,`Q1`

`ANY_BYTES{0,4}`

; set last character of hostname to null byte
sb zero,-0x1(`Q3`)

; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
