; This pattern tests for the absence of CVE-2015-3145 and its fix for MIPS:BE:32:default.

; Info about the CVE: https://github.com/curl/curl/commit/b5f947b8ac0e282c61c75b69cd5b9d37dafc6959
; Summary: A cookie path is passed into a function, and the first character is removed if it is a
; double quote. It then checks if the last character (strlen(new_path) - 1) is a double quote and
; sets the last character to 0 if so. If a single double quote is passed in as the cookie path, the
; last character's index would be calculated as -1.

; CVE-2015-3145 was introduced in v7.31.0 when the sanitize_cookie_path() function was added in
; cookie.c and when the spath field was added in the Cookie struct in cookie.h. Even though the
; vulnerability itself is located in sanitize_cookie_path(), we can check whether the vulnerability
; had been introduced yet by checking for the presence (or lack of) the spath field.

; The cookie.c file contains a freecookie() function which frees several values in the Cookie
; struct. We can check how many times free is called - eight times before spath was added, nine
; times after spath was added.

; Prevulnerable code:
; // notice co->spath is missing, as it has not been introduced to the code yet
; static void freecookie(struct Cookie *co)
; {
;   if(co->expirestr)
;     free(co->expirestr);
;   if(co->domain)
;     free(co->domain);
;   if(co->path)
;     free(co->path);
;   if(co->name)
;     free(co->name);
;   if(co->value)
;     free(co->value);
;   if(co->maxage)
;     free(co->maxage);
;   if(co->version)
;     free(co->version);
;
;   free(co);
; }

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.1.1_4.3.3.0998 build 20190730.zip.1784ba2d9115ffed3202a9f612afee23ce50103c8056fae182640fe85a3cb15f
;        0001a46a 70 b5           push       { r4, r5, r6, lr }
;        0001a46c 04 46           mov        r4,r0
;        0001a46e 13 4a           ldr        r2,[DAT_0001a4bc]
;        0001a470 7b 44           add        r3,pc
;        0001a472 00 6a           ldr        r0,[r0,#0x20]
;        0001a474 9d 58           ldr        r5,[r3,r2]=>->Curl_cfree
;        0001a476 08 b1           cbz        r0,LAB_0001a47c
;        0001a478 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a47a 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a47c
;        0001a47c 20 69           ldr        r0,[r4,#0x10]
;        0001a47e 08 b1           cbz        r0,LAB_0001a484
;        0001a480 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a482 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a484
;        0001a484 e0 68           ldr        r0,[r4,#0xc]
;        0001a486 08 b1           cbz        r0,LAB_0001a48c
;        0001a488 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a48a 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a48c
;        0001a48c 60 68           ldr        r0,[r4,#0x4]
;        0001a48e 08 b1           cbz        r0,LAB_0001a494
;        0001a490 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a492 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a494
;        0001a494 a0 68           ldr        r0,[r4,#0x8]
;        0001a496 08 b1           cbz        r0,LAB_0001a49c
;        0001a498 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a49a 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a49c
;        0001a49c e0 6a           ldr        r0,[r4,#0x2c]
;        0001a49e 08 b1           cbz        r0,LAB_0001a4a4
;        0001a4a0 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a4a2 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a4a4
;        0001a4a4 a0 6a           ldr        r0,[r4,#0x28]
;        0001a4a6 08 b1           cbz        r0,LAB_0001a4ac
;        0001a4a8 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a4aa 98 47           blx        r3=><EXTERNAL>::free
;                             LAB_0001a4ac
;        0001a4ac 2b 68           ldr        r3,[r5,#0x0]=>-><EXTERNAL>::free
;        0001a4ae 20 46           mov        r0,r4
;        0001a4b0 bd e8 70 40     pop.w      { r4, r5, r6, lr }
;        0001a4b4 18 47           bx         r3=><EXTERNAL>::free

; start of freecookie() function
push {`Q1/r..?`, `Q2/r..?`, `Q3/r..?`, `Q4/...?`}
`ANY_BYTES{0,14}`

cbz `Q5/r..?`,`*`
ldr `Q6/r..?`,[`Q7/r..?`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

cbz `Q5`,`*`
ldr `Q6`,[`Q7`,#0x0]
blx `Q6`
`ANY_BYTES{0,4}`

ldr `Q6`,[`Q7`,#0x0]
`ANY_BYTES{0,6}`
bx `Q8/r..?`

; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
