; This pattern tests for the presence of CVE-2015-3145 for ARM:LE:32:v8.

; Info about the CVE: https://github.com/curl/curl/commit/b5f947b8ac0e282c61c75b69cd5b9d37dafc6959
; Summary: A cookie path is passed into a function, and the first character is removed if it is a
; double quote. It then checks if the last character (strlen(new_path) - 1) is a double quote and
; sets the last character to 0 if so. If a single double quote is passed in as the cookie path, the
; last character's index would be calculated as -1.

; Vulnerable code:
; if(new_path[0] == '\"') {
;   memmove((void *)new_path, (const void *)(new_path + 1), strlen(new_path));
; }
; if(new_path[strlen(new_path) - 1] == '\"') { // (strlen(new_path) - 1) could be negative
;   new_path[strlen(new_path) - 1] = 0x0;
; }

; Pattern written with: libcurl/libcurl_versions/cameras/libcurl.so.4.3.0_yi_home_1.8.5.1I_201506291725
;        00017380 00 20 d4 e5     ldrb       r2,[r4,#0x0]
;        00017384 22 00 52 e3     cmp        r2,#0x22
;        00017388 21 00 00 0a     beq        LAB_00017414
;                             LAB_0001738c
;        0001738c 04 00 a0 e1     cpy        r0,r4
;        00017390 62 eb ff eb     bl         <EXTERNAL>::strlen
;        00017394 01 c0 40 e2     sub        r12,r0,#0x1
;        00017398 0c 30 d4 e7     ldrb       r3,[r4,r12]
;        0001739c 22 00 53 e3     cmp        r3,#0x22
;        000173a0 00 30 a0 03     moveq      r3,#0x0
; ...
;                              LAB_00017414
;        00017414 41 eb ff eb     bl         <EXTERNAL>::strlen
;        00017418 01 10 84 e2     add        r1,r4,#0x1
;        0001741c 00 20 a0 e1     cpy        r2,r0
;        00017420 04 00 a0 e1     cpy        r0,r4
;        00017424 53 ea ff eb     bl         <EXTERNAL>::memmove


; new_path[0] == '\"'
ldrb `Q1/r..?`,[`Q2/r..?`,#0x0]
cmp `Q1`,#0x22

beq `*`

; call strlen
cpy r0,`Q2`
bl `*`

; calculate (strlen - 1)
sub `Q3/r..?`,r0,#0x1

; new_path[strlen(new_path) - 1] == '\"'
ldrb `Q4/r..?`,[`Q2`,`Q3`]
cmp `Q4`,#0x22

; put 0 in new_path[strlen(new_path) - 1] if above true
moveq `Q4`,#0x0

`ANY_BYTES{100,120}`

; call strlen
bl `*`

; call memmove
add r1,`Q2`,#0x1
cpy r2,r0
cpy r0,r4
bl `*`

; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
