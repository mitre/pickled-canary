; This pattern tests for the patch of CVE-2015-3144 for ARM:LE:32:v8.

; Info about the CVE: https://github.com/curl/curl/commit/0583e87ada7a3cfb10904ae4ab61b339582c5bd3
; Summary: A hostname is passed into a function, and the last character (len - 1) character is
; read. It is also set to a null character if certain conditions are met. A hostname that has a
; length of zero will cause the program to read and write to memory not part of the hostname.

; Patched code:
; len = strlen(host->name);
; if(len && (host->name[len-1] == '.')) //makes sure len is not negative
;   host->name[len-1]=0;

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.5.3.0_2.1.2__b.img.b73debbf9bcb1ab55e4dd75acd99d000727be6c95d72609873429a591dd70120
;        00026684 10  bb  ff  eb    bl         <EXTERNAL>::strlen
;        00026688 00  00  50  e3    cmp        r0,#0x0
;        0002668c 04  40  8f  e0    add        r4,pc,r4
;        00026690 04  00  00  0a    beq        LAB_000266a8
;        00026694 01  00  40  e2    sub        r0,r0,#0x1
;        00026698 00  30  d6  e7    ldrb       r3,[r6,r0]
;        0002669c 2e  00  53  e3    cmp        r3,#0x2e

; call to strlen
bl `*`

; check whether len is 0
cmp `Q1/r..?`,#0x0

`ANY_BYTES{0,4}`

; the && short circuit if len is 0
beq `*`

; calculate (len-1)
sub `Q1`,`Q1`,#0x1

; get last character of hostname -- host->name[len-1]
ldrb `Q2/r..?`,[`Q3/r..?`,`Q1`]

; check if last character of hostname is '.' character
cmp `Q2`,#0x2e

; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
