; This pattern tests for the absence of CVE-2015-3145 and its fix for MIPS:BE:32:default.

; Info about the CVE: https://github.com/curl/curl/commit/b5f947b8ac0e282c61c75b69cd5b9d37dafc6959
; Summary: A cookie path is passed into a function, and the first character is removed if it is a
; double quote. It then checks if the last character (strlen(new_path) - 1) is a double quote and
; sets the last character to 0 if so. If a single double quote is passed in as the cookie path, the
; last character's index would be calculated as -1.

; CVE-2015-3145 was introduced in v7.31.0 when the sanitize_cookie_path() function was added in
; cookie.c and when the spath field was added in the Cookie struct in cookie.h. Even though the
; vulnerability itself is located in sanitize_cookie_path(), we can check whether the vulnerability
; had been introduced yet by checking for the presence (or lack of) the spath field.

; The cookie.c file contains a freecookie() function which frees several values in the Cookie
; struct. We can check how many times free is called - eight times before spath was added, nine
; times after spath was added.

; Prevulnerable code:
; // notice co->spath is missing, as it has not been introduced to the code yet
; static void freecookie(struct Cookie *co)
; {
;   if(co->expirestr)
;     free(co->expirestr);
;   if(co->domain)
;     free(co->domain);
;   if(co->path)
;     free(co->path);
;   if(co->name)
;     free(co->name);
;   if(co->value)
;     free(co->value);
;   if(co->maxage)
;     free(co->maxage);
;   if(co->version)
;     free(co->version);
;
;   free(co);
; }

; Pattern written with: 1) libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.2.0_3.0.0.4.382.51641_Global.zip.0e5896dd52fc8672b0abc4ab66c16166b043965f5b26a4555ff594ebaa88d812_1
;        0001dc08 30 44 2d e9     stmdb      sp!,{r4 r5 r10 lr}
; ...
;                             LAB_0001dc84
;        0001dc84 b0 50 9f e5     ldr        r5,[DAT_0001dd3c]
;        0001dc88 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dc8c 0f e0 a0 e1     mov        lr,pc
;        0001dc90 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dc94 10 00 94 e5     ldr        r0,[r4,#0x10]
;        0001dc98 00 00 50 e3     cmp        r0,#0x0
;        0001dc9c e4 ff ff 0a     beq        LAB_0001dc34
;                             LAB_0001dca0
;        0001dca0 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dca4 0f e0 a0 e1     mov        lr,pc
;        0001dca8 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dcac 0c 00 94 e5     ldr        r0,[r4,#0xc]
;        0001dcb0 00 00 50 e3     cmp        r0,#0x0
;        0001dcb4 e1 ff ff 0a     beq        LAB_0001dc40
;                             LAB_0001dcb8
;        0001dcb8 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dcbc 0f e0 a0 e1     mov        lr,pc
;        0001dcc0 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dcc4 04 00 94 e5     ldr        r0,[r4,#0x4]
;        0001dcc8 00 00 50 e3     cmp        r0,#0x0
;        0001dccc de ff ff 0a     beq        LAB_0001dc4c
;                             LAB_0001dcd0
;        0001dcd0 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dcd4 0f e0 a0 e1     mov        lr,pc
;        0001dcd8 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dcdc 08 00 94 e5     ldr        r0,[r4,#0x8]
;        0001dce0 00 00 50 e3     cmp        r0,#0x0
;        0001dce4 db ff ff 0a     beq        LAB_0001dc58
;                             LAB_0001dce8
;        0001dce8 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dcec 0f e0 a0 e1     mov        lr,pc
;        0001dcf0 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dcf4 28 00 94 e5     ldr        r0,[r4,#0x28]
;        0001dcf8 00 00 50 e3     cmp        r0,#0x0
;        0001dcfc d8 ff ff 0a     beq        LAB_0001dc64
;                             LAB_0001dd00
;        0001dd00 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dd04 0f e0 a0 e1     mov        lr,pc
;        0001dd08 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dd0c 24 00 94 e5     ldr        r0,[r4,#0x24]
;        0001dd10 00 00 50 e3     cmp        r0,#0x0
;        0001dd14 d5 ff ff 0a     beq        LAB_0001dc70
;                             LAB_0001dd18
;        0001dd18 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dd1c 0f e0 a0 e1     mov        lr,pc
;        0001dd20 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dd24 05 30 9a e7     ldr        r3=>Curl_cfree,[r10,r5]=>->Curl_cfree
;        0001dd28 04 00 a0 e1     cpy        r0,r4
;        0001dd2c 0f e0 a0 e1     mov        lr,pc
;        0001dd30 00 f0 93 e5     ldr        pc=><EXTERNAL>::free,[r3,#0x0]=>-><EXTERNAL>::
;        0001dd34 30 84 bd e8     ldmia      sp!,{r4 r5 r10 pc}

; and 2) libcurl/libcurl_versions/cameras/libcurl.so.4.2.0_yi_home_1.8.3.4J_201412291009
;        00019750 70 40 2d e9     stmdb      sp!,{r4 r5 r6 lr}
;        00019754 00 40 a0 e1     cpy        r4,r0
;        00019758 20 00 90 e5     ldr        r0,[r0,#0x20]
;        0001975c c4 50 9f e5     ldr        r5,[DAT_00019828]
;        00019760 00 00 50 e3     cmp        r0,#0x0
;        00019764 05 50 8f e0     add        r5,pc,r5
;        00019768 2c 00 00 0a     beq        LAB_00019820
;        0001976c b8 60 9f e5     ldr        r6,[DAT_0001982c]
;        00019770 06 10 95 e7     ldr        r1=>Curl_cfree,[r5,r6]=>->Curl_cfree
;        00019774 00 30 91 e5     ldr        r3,[r1,#0x0]=>-><EXTERNAL>::free
;        00019778 33 ff 2f e1     blx        r3=><EXTERNAL>::free
;                             LAB_0001977c
;        0001977c 10 00 94 e5     ldr        r0,[r4,#0x10]
;        00019780 00 00 50 e3     cmp        r0,#0x0
;        00019784 02 00 00 0a     beq        LAB_00019794
;        00019788 06 c0 95 e7     ldr        r12,[r5,r6]=>->Curl_cfree
;        0001978c 00 20 9c e5     ldr        r2,[r12,#0x0]=>-><EXTERNAL>::free
;        00019790 32 ff 2f e1     blx        r2=><EXTERNAL>::free
;                             LAB_00019794
;        00019794 0c 00 94 e5     ldr        r0,[r4,#0xc]
;        00019798 00 00 50 e3     cmp        r0,#0x0
;        0001979c 02 00 00 0a     beq        LAB_000197ac
;        000197a0 06 e0 95 e7     ldr        lr,[r5,r6]=>->Curl_cfree
;        000197a4 00 30 9e e5     ldr        r3,[lr,#0x0]=>-><EXTERNAL>::free
;        000197a8 33 ff 2f e1     blx        r3=><EXTERNAL>::free
;                             LAB_000197ac
;        000197ac 04 00 94 e5     ldr        r0,[r4,#0x4]
;        000197b0 00 00 50 e3     cmp        r0,#0x0
;        000197b4 02 00 00 0a     beq        LAB_000197c4
;        000197b8 06 20 95 e7     ldr        r2=>Curl_cfree,[r5,r6]=>->Curl_cfree
;        000197bc 00 10 92 e5     ldr        r1,[r2,#0x0]=>-><EXTERNAL>::free
;        000197c0 31 ff 2f e1     blx        r1=><EXTERNAL>::free
;                             LAB_000197c4
;        000197c4 08 00 94 e5     ldr        r0,[r4,#0x8]
;        000197c8 00 00 50 e3     cmp        r0,#0x0
;        000197cc 02 00 00 0a     beq        LAB_000197dc
;        000197d0 06 30 95 e7     ldr        r3=>Curl_cfree,[r5,r6]=>->Curl_cfree
;        000197d4 00 c0 93 e5     ldr        r12,[r3,#0x0]=>-><EXTERNAL>::free
;        000197d8 3c ff 2f e1     blx        r12=><EXTERNAL>::free
;                             LAB_000197dc
;        000197dc 2c 00 94 e5     ldr        r0,[r4,#0x2c]
;        000197e0 00 00 50 e3     cmp        r0,#0x0
;        000197e4 02 00 00 0a     beq        LAB_000197f4
;        000197e8 06 e0 95 e7     ldr        lr,[r5,r6]=>->Curl_cfree
;        000197ec 00 10 9e e5     ldr        r1,[lr,#0x0]=>-><EXTERNAL>::free
;        000197f0 31 ff 2f e1     blx        r1=><EXTERNAL>::free
;                             LAB_000197f4
;        000197f4 28 00 94 e5     ldr        r0,[r4,#0x28]
;        000197f8 00 00 50 e3     cmp        r0,#0x0
;        000197fc 02 00 00 0a     beq        LAB_0001980c
;        00019800 06 c0 95 e7     ldr        r12,[r5,r6]=>->Curl_cfree
;        00019804 00 20 9c e5     ldr        r2,[r12,#0x0]=>-><EXTERNAL>::free
;        00019808 32 ff 2f e1     blx        r2=><EXTERNAL>::free
;                             LAB_0001980c
;        0001980c 06 10 95 e7     ldr        r1=>Curl_cfree,[r5,r6]=>->Curl_cfree
;        00019810 04 00 a0 e1     cpy        r0,r4
;        00019814 00 30 91 e5     ldr        r3,[r1,#0x0]=>-><EXTERNAL>::free
;        00019818 33 ff 2f e1     blx        r3=><EXTERNAL>::free
;        0001981c 70 80 bd e8     ldmia      sp!,{r4 r5 r6 pc}

; start of freecookie() function
stmdb sp!,{`Q1/r..?` `Q2/r..?` `Q3/r..?` `Q4/...?`}

; each ldr calls free

`START_OR`
    `ANY_BYTES{0, 144}`

    ldr pc,[`Q5/r..?`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,16}`
    beq `*`
    `ANY_BYTES{0,16}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,20}`

    ldr pc,[`Q5`,#0x0]
    `ANY_BYTES{0,8}`
`OR`
    `ANY_BYTES{0,40}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q6/...?`,[`Q7/...?`,#0x0]
    blx `Q6`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q8/...?`,[`Q9/...?`,#0x0]
    blx `Q8`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q10/...?`,[`Q11/...?`,#0x0]
    blx `Q10`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q12/...?`,[`Q13/...?`,#0x0]
    blx `Q12`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q14/...?`,[`Q15/...?`,#0x0]
    blx `Q14`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q16/...?`,[`Q17/...?`,#0x0]
    blx `Q16`
    `ANY_BYTES{0,12}`

    beq `*`
    `ANY_BYTES{0,12}`
    ldr `Q18/...?`,[`Q19/...?`,#0x0]
    blx `Q18`
    `ANY_BYTES{0,8}`

    ldr `Q20/...?`,[`Q21/...?`,#0x0]
    `ANY_BYTES{0,8}`
    `START_OR`
        blx `Q20`
    `OR`
        bx `Q20`
    `END_OR`
`END_OR`

;ldmia sp!,{`Q1` `Q2` `Q3` `Q8/.*`}


; Copyright (C) 2023 The MITRE Corporation All Rights Reserved
