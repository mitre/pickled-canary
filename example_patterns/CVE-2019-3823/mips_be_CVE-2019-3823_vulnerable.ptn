; This pattern tests for the presence of CVE-2019-3823 for MIPS:BE:32:default.

; Info about the CVE: https://github.com/curl/curl/commit/39df4073e5413fcdbb5a38da0c1ce6f1c0ceb484
; Summary: This CVE involves a buffer overflow vulnerability while using the strtol function. A
; string is passed into the strtol function, but if no null terminator is present within the
; string's buffer, strtol will overread the buffer.

; Vulnerable code:
; if(line[3] == ' ' || len == 5) {
;    *resp = curlx_sltosi(strtol(line, NULL, 10)); //line variable may not have null terminator
; }

; Pattern written with: 1) libcurl/libcurl_versions/from_tool/testdata/libcurl.so.5.4.0_3.9.3.7537.bin.de3ea486b7cbea778d09bd93ee1ab7fc213302a3861cadc575aa0704ffc94705
;        0004bef0 24  02  00  20    _li        v0,0x20
;        0004bef4 80  a3  00  03    lb         v1,0x3 (a1)
;        0004bef8 10  62  00  03    beq        v1,v0,LAB_0004bf08
;        0004befc 24  02  00  05    _li        v0,0x5
;        0004bf00 14  c2  00  10    bne        a2,v0,LAB_0004bf44
;        0004bf04 24  02  00  2d    _li        v0,0x2d
;                             LAB_0004bf08
;        0004bf08 8f  99  89  6c    lw         t9,-0x7694 (gp)=>-><EXTERNAL>::strtol
;        0004bf0c 00  00  28  21    clear      a1
;        0004bf10 03  20  f8  09    jalr       t9=><EXTERNAL>::strtol
;        0004bf14 24  06  00  0a    _li        a2,0xa
;        0004bf18 8f  bc  00  10    lw         gp,local_10 (sp)
;        0004bf1c 8f  99  81  e4    lw         t9,-0x7e1c (gp)=>->FUN_0004eca0
;        0004bf20 03  20  f8  09    jalr       t9=>FUN_0004eca0

; and 2)
;        0004ea44 80  a2  00  03    lb         v0,0x3 (a1)
;        0004ea48 24  03  00  20    li         v1,0x20
;        0004ea4c 10  43  00  0e    beq        v0,v1,LAB_0004ea88
;        0004ea50 24  03  00  05    _li        v1,0x5
;        0004ea54 10  c3  00  0c    beq        a2,v1,LAB_0004ea88
;        0004ea58 24  03  00  2d    _li        v1,0x2d
;        0004ea5c 14  43  ff  de    bne        v0,v1,LAB_0004e9d8
;        0004ea60 00  00  10  21    _clear     v0
;        0004ea64 8e  02  04  90    lw         v0,0x490 (s0)
;        0004ea68 24  03  00  02    li         v1,0x2
;        0004ea6c 10  43  00  03    beq        v0,v1,LAB_0004ea7c
;        0004ea70 24  03  00  07    _li        v1,0x7
;        0004ea74 14  43  ff  d7    bne        v0,v1,LAB_0004e9d4
;        0004ea78 00  00  00  00    _nop
;                             LAB_0004ea7c
;        0004ea7c 24  02  00  01    li         v0,0x1
;        0004ea80 10  00  ff  d5    b          LAB_0004e9d8
;        0004ea84 ac  e2  00  00    _sw        v0,0x0 (a3)
;                             LAB_0004ea88
;        0004ea88 8f  99  88  34    lw         t9,-0x77cc (gp)=>-><EXTERNAL>::strtol
;        0004ea8c 00  a0  20  21    move       a0,a1
;        0004ea90 af  a7  00  20    sw         a3,local_10 (sp)
;        0004ea94 00  00  28  21    clear      a1
;        0004ea98 03  20  f8  09    jalr       t9=><EXTERNAL>::strtol
;        0004ea9c 24  06  00  0a    _li        a2,0xa
;        0004eaa0 8f  bc  00  10    lw         gp,local_20 (sp)
;        0004eaa4 8f  99  82  24    lw         t9,-0x7ddc (gp)=>->curlx_sltosi


; check line[3] == ' '
`START_OR`
    li `Q1/v.`,0x20
    lb `Q2/v.`,0x3(`Q4/[as].`)
`OR`
    lb `Q2`,0x3(`Q4`)
    li `Q1`,0x20
`END_OR`
beq `Q2`,`Q1`,`*`

; check len == 5
li `Q3/v.`,0x5
`START_OR`
    beq `Q5/[as].`,`Q3`,`*`
`OR`
    bne `Q5`,`Q3`,`*`
`END_OR`

`ANY_BYTES{0,64}`

; call strtol
jalr `*`

`ANY_BYTES{0,16}`

; call curlx_sltosi
`START_OR`
    jalr `*`
`OR`
    bal `*`
`END_OR`

; Copyright (C) 2023 The MITRE Corporation All Rights Reserved
