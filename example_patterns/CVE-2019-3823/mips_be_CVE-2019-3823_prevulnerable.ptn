; This pattern tests for versions of libcurl before code for CVE-2019-3823 existed.
; Pattern written for MIPS:BE:32:default.

; Info about the CVE: https://github.com/curl/curl/commit/39df4073e5413fcdbb5a38da0c1ce6f1c0ceb484
; Summary: This CVE involves a buffer overflow vulnerability while using the strtol function. A
; string is passed into the strtol function, but if no null terminator is present within the
; string's buffer, strtol will overread the buffer.

; Prevulnerable code:
; Version 7.21.3 - 7.33.0
;   if((result = (line[3] == ' ')) != 0)
;    *resp = curlx_sltosi(strtol(line, NULL, 10));

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.3.0_V1.00(AAKG.12)C0.zip.1e4e2676fe5e1ac9cd0aa8ae672d2995fc4aa9f0a6512b8f12b4ac92f55ebb42
;        00047000 82 35 00 03     lb         s5,0x3(s1)
;        00047004 3a b5 00 20     xori       s5,s5,0x20
;        00047008 2e b5 00 01     sltiu      s5,s5,0x1
;        0004700c 52 a0 00 0d     beql       s5,zero,LAB_00047044
;        00047010 8e 03 03 e0     _lw        v1,0x3e0(s0)
;        00047014 8f 99 85 6c     lw         t9,-0x7a94(gp)=>-><EXTERNAL>::strtol             = 0004edf0
;        00047018 00 00 28 21     clear      a1
;        0004701c 24 06 00 0a     li         a2,0xa
;        00047020 03 20 f8 09     jalr       t9=><EXTERNAL>::strtol                           long strtol(char * __nptr, char
;        00047024 02 20 20 21     _move      a0,s1
;        00047028 8f bc 00 10     lw         gp,local_30(sp)
;        0004702c 8f 99 80 80     lw         t9,-0x7f80(gp)=>->FUN_0004a150                   = 0004a150
;        00047030 04 11 0c 47     bal        FUN_0004a150                                     undefined FUN_0004a150()

; check line[3] == ' '
lb `Q1/s.`,0x3(`Q2/s.`)
xori `Q1`,`Q1`,0x20
`ANY_BYTES{0,4}`
`START_OR`
    beql `Q1`,zero,`*`
`OR`
    beq `Q1`,zero,`*`
`END_OR`

`ANY_BYTES{0,8}`

; load arguments and call strtol
clear a1
`START_OR`
    li a2,0xa
    jalr `Q3/t.`
`OR`
    jalr `Q3`
    li a2,0xa
`END_OR`

`ANY_BYTES{0,12}`

; call curlx_sltosi
bal `*`


; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
