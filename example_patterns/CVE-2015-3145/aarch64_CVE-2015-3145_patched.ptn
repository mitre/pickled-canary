; This pattern tests for the patch of CVE-2015-3145 for AARCH64:LE:64:v8A.

; Info about the CVE: https://github.com/curl/curl/commit/b5f947b8ac0e282c61c75b69cd5b9d37dafc6959
; Summary: A cookie path is passed into a function, and the first character is removed if it is a
; double quote. It then checks if the last character (strlen(new_path) - 1) is a double quote and
; sets the last character to 0 if so. If a single double quote is passed in as the cookie path, the
; last character's index would be calculated as -1.

; Patched code:
; len = strlen(new_path);
; if(new_path[0] == '\"') {
;   memmove((void *)new_path, (const void *)(new_path + 1), len);
;   len--;
; }
; if(len && (new_path[len - 1] == '\"')) {
;   new_path[len - 1] = 0x0;
;   len--;
; }

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.5.0_Fix.zip.f8bc4dff8327de8545410a17827bc0184992b22ffa8d27cd75e9aea49be9707a
;        0010ceb4 0f f1 ff 97     bl         <EXTERNAL>::strlen
;        0010ceb8 f4 03 00 aa     mov        x20,x0
;        0010cebc 60 02 40 39     ldrb       w0,[x19]
;        0010cec0 1f 88 00 71     cmp        w0,#0x22
;        0010cec4 c1 00 00 54     b.ne       LAB_0010cedc
;        0010cec8 e2 03 14 aa     mov        x2,x20
;        0010cecc e0 03 13 aa     mov        x0,x19
;        0010ced0 61 06 00 91     add        x1,x19,#0x1
;        0010ced4 94 06 00 d1     sub        x20,x20,#0x1
;        0010ced8 9e ec ff 97     bl         <EXTERNAL>::memmove
;                             LAB_0010cedc
;        0010cedc f4 00 00 b4     cbz        x20,LAB_0010cef8
;        0010cee0 80 06 00 d1     sub        x0,x20,#0x1
;        0010cee4 61 6a 60 38     ldrb       w1,[x19, x0, LSL ]
;        0010cee8 3f 88 00 71     cmp        w1,#0x22
;        0010ceec 61 00 00 54     b.ne       LAB_0010cef8
;        0010cef0 7f 6a 20 38     strb       wzr,[x19, x0, LSL ]
;        0010cef4 f4 03 00 aa     mov        x20,x0


; call to strlen
bl `*`
mov `Q1/x..?`,x0

; new_path[0] == '\"'
ldrb `Q2/w..?`,[`Q3/x..?`]
cmp `Q2`,#0x22

`ANY_BYTES{0,4}`

; call memmove and len--
mov x2,`Q1`
mov x0,`Q3`
add x1,`Q3`,#0x1
sub `Q1`,`Q1`,#0x1
bl `*`

`ANY_BYTES{0,4}`

; len--
sub `Q4/x..?`,`Q1`,#0x1

; new_path[strlen(new_path) - 1] == '\"'
ldrb `Q5/w..?`,[`Q3`,`Q4`, LSL]
cmp `Q5`,#0x22

`ANY_BYTES{0,4}`

; put 0 in new_path[strlen(new_path) - 1] if above true
strb wzr,[`Q3`,`Q4`, LSL]

; Copyright (C) 2025 The MITRE Corporation All Rights Reserved
