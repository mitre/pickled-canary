; This pattern tests for the presence of CVE-2019-3823 for x86:LE:64:default.

; Info about the CVE: https://github.com/curl/curl/commit/39df4073e5413fcdbb5a38da0c1ce6f1c0ceb484
; Summary: This CVE involves a buffer overflow vulnerability while using the strtol function. A
; string is passed into the strtol function, but if no null terminator is present within the
; string's buffer, strtol will overread the buffer.

; Vulnerable code:
; if(line[3] == ' ' || len == 5) {
;    *resp = curlx_sltosi(strtol(line, NULL, 10)); //line variable may not have null terminator
; }

; Pattern written with: libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.5.0_6.10.2 (x86).zip.2ffde1334bfedebc5f8647a7f1b7d1aeb6eb26e300c187f9529d8cbb4e025dea
;        00140206 48  83  fb  05    CMP        RBX ,0x5
;        0014020a 0f  94  c3       SETZ       BL
;        0014020d 80  fa  20       CMP        DL,0x20
;        00140210 0f  94  c0       SETZ       AL
;        00140213 08  c3           OR         BL,AL
;        00140215 75  29           JNZ        LAB_00140240
;        ...
;                             LAB_00140240
;        00140240 ba  0a  00       MOV        EDX ,0xa
;                 00  00
;        00140245 31  f6           XOR        ESI ,ESI
;        00140247 48  89  ef       MOV        RDI ,RBP
;        0014024a e8  c1  a1       CALL       <EXTERNAL>::strtol
;                 fc  ff
;        0014024f 48  89  c7       MOV        RDI ,RAX
;        00140252 e8  29  2f       CALL       FUN_00143180
;                 00  00


; and 2) libcurl/libcurl_versions/from_tool/testdata/libcurl.so.4.4.0_OceanStor BCManager V200R001C00SPC220__1.action.16f41eb05d826e68ec793247c65ede64ce2ff854e2409379e438e8fe3b18bb24
;        0013f528 3c  20           CMP        AL,0x20
;        0013f52a 74  24           JZ         LAB_0013f550
;        0013f52c 49  83  fc  05    CMP        R12 ,0x5
; ...
;        0013f55a e8  b1  9a       CALL       <EXTERNAL>::strtol
;                 fc  ff
;        0013f55f 48  89  c7       MOV        RDI ,RAX
;        0013f562 e8  19  2b       CALL       curlx_sltosi
;                 00  00


`START_OR`
    ; check len == 5
    CMP `Q1/R.+`,0x5
    `ANY_BYTES{0,3}`
    ; check line[3] == ' '
    CMP `Q2/.L`,0x20
`OR`
    ; check line[3] == ' '
    CMP `Q2`,0x20
    `ANY_BYTES{0,2}`
    ; check len == 5
    CMP `Q1`,0x5
`END_OR`

`ANY_BYTES{0,58}`

; call strtol
CALL `*`

`ANY_BYTES{0,3}`

; call curlx_sltosi
CALL `*`

; Copyright (C) 2023 The MITRE Corporation All Rights Reserved
